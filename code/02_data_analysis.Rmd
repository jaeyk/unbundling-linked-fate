---
title: "Data cleaning"
author: "Jae Yeon Kim"
output:
html_document: 
  toc: true
  theme: united
---

## 0. Setup 

```{r}

# Clean up the environment

# rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        naniar, # for missing data
        mice, # for imputation
        ggpubr, # for arranging ggplots   
        ggthemes, # for fancy ggplot themes
        BaylorEdPsych, # testing patterns among missing values
        MKinfer, # for inferential statistics 
        wBoot, # for bootstrapping methods 
        plotrix, # for various plotting functions
        PerformanceAnalytics, # for corr plots 
        GGally, # for corr plots
        patchwork, # for easy ggarrange
        psych, # for psychometric analysis
        irr, # reliability test
        rel # for bootstrapping kappa
)

```

### 1. Importing data 

```{r}

# Importing data 
df <- read_csv("/home/jae/validating-two-linked-fates/raw_data/processed_survey.csv")

# Excluding other respondents (too small to calucate CIs)
df <- subset(df, race != "Other")

# Using only complete cases
df <- df[complete.cases(df),] %>% as.data.frame()

```

### 2. Descriptive analysis 

#### 2.1. Mean and SEs

```{r}

fate_stat <- df %>%
  group_by(race) %>%
  summarize(mean = mean(linked_fate),
            se = std.error(linked_fate))

progress_stat <- df %>%
  group_by(race) %>%
  summarize(mean = mean(linked_progress),
            se = std.error(linked_progress))

hurt_stat <- df %>%
  group_by(race) %>%
  summarize(mean = mean(linked_hurt),
            se = std.error(linked_hurt))

summary_stat <- bind_rows(mutate(fate_stat, Type = "Linked fate"),
                          mutate(progress_stat, Type = "Linked progress"),
                          mutate(hurt_stat, Type = "Linked hurt"))
  
```

#### 2.2. Visualizing the results 

```{r}

summary_stat %>%  
  ggplot(aes(x = fct_reorder(race, mean), y = mean, 
             ymax = mean + se, 
             ymin = mean - se, fill = Type)) +
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(width=.2,                    # Width of the error bars
                  position=position_dodge(.9)) +
    theme_base() +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dashed") +
    labs(x = "Race", y = "Mean",
         title = "Average responses by racial groups") 

ggsave("/home/jae/validating-two-linked-fates/outputs/descriptive_stat_plot.png", width = 7)
```

  
### 3. Correlation analysis

For more information, see [this blog post](http://www.sthda.com/english/wiki/correlation-test-between-two-variables-in-r).

- Person correlation: 1. assuming a linear dependence between X and Y, assuming X and Y are from normal distribution 
- Kendal tau and Spearman rho: rank-based correlation coefficients 
- All tests are two-sided.

```{r}

table(df$race)

```

#### 3.1. Density plots

```{r}
# Create a custom plot 
corr_plot <- function(data){data %>%
  gather(Measures, Responses, linked_fate, linked_progress, linked_hurt) %>%
  ggplot(aes(x = Responses)) + geom_density() + theme_base() + labs(y = "Density") + facet_wrap(~Measures)}

# Apply to each data and bind htem 
p1 <- corr_plot(df %>% filter(race == "Asians")) + ggtitle("Asian Americans")
p2 <- corr_plot(df %>% filter(race == "Blacks")) + ggtitle("Blacks")
p3 <- corr_plot(df %>% filter(race == "Whites")) + ggtitle("Whites")
p4 <- corr_plot(df %>% filter(race == "Latinx")) + ggtitle("Latinx")

p1 + p4 + p3 + p2

ggsave("/home/jae/validating-two-linked-fates/outputs/density_plot.png", width = 10)
```

#### 3.2. Four correlation coefficients 

```{r}

# Individual case analysis 

# Fate - Progress
fate_progress <- df %>%
  group_by(race) %>%
  summarize(Pearson = cor.test(linked_fate, linked_progress, method = c("pearson"))$estimate %>% as.numeric(),
            Boot_Pearson = boot.cor.bca(linked_fate, linked_progress)$Boot.values %>% mean(), 
            Kendall = cor.test(linked_fate, linked_progress, method = c("kendall"))$estimate %>% as.numeric(),
            Spearman = cor.test(linked_fate, linked_progress, method = c("spearman"))$estimate %>% as.numeric())

# Fate - Hurt 
fate_hurt <- df %>%
  group_by(race) %>%
  summarize(Pearson = cor.test(linked_fate, linked_hurt, method = c("pearson"))$estimate %>% as.numeric(),
            Boot_Pearson = boot.cor.bca(linked_fate, linked_hurt)$Boot.values %>% mean(),
            Kendall = cor.test(linked_fate, linked_hurt, method = c("kendall"))$estimate %>% as.numeric(),
            Spearman = cor.test(linked_fate, linked_hurt, method = c("spearman"))$estimate %>% as.numeric())

# Combining the results 

cor_results <- bind_rows(mutate(fate_progress, Type = "fate_progress"),
          mutate(fate_hurt, Type = "fate_hurt"))

cor_results <- cor_results %>%
  gather(Test, coeffs, c("Pearson", "Boot_Pearson", "Kendall", "Spearman"))

```

#### 3.3. Visualizing the results  

```{r}
cor_results %>%
  mutate(coeffs = round(coeffs, 4)) %>% 
  ggplot(aes(x = fct_reorder(Test, coeffs), y = coeffs, fill = Type)) +
  geom_col(position = "dodge") +
  facet_wrap(~race) +
  coord_flip() + 
  theme_base() +
  labs(x = "Race", y = "Correlation coefficients", 
       title = "Correlation test resuts")

ggsave("/home/jae/validating-two-linked-fates/outputs/cor_coeffs_plot.png")

```

### 4. Reliability test 

```{r}

# Create a function

reliability_test <- function(data){
irr <- data %>%
  dplyr::select(linked_fate, linked_progress, linked_hurt) %>%
  kappam.fleiss(exact = TRUE) # Conger's kappa
irr$value}

reliability_boot_test <- function(data){
irr <- (df %>%
  dplyr::select(linked_fate, linked_progress, linked_hurt) %>%
  ckap(R = 999))

kappa <- irr$est %>% as.numeric()
ub <- irr$ub %>% as.numeric()
lb <- irr$lb %>% as.numeric()

return(c(kappa, ub, lb))
}

# Reliability tests 

## No bootstrapping 

kappa_plot <- data.frame(Kappa = c(reliability_test(df %>% filter(race == "Asians")), 
                     reliability_test(df %>% filter(race == "Latinx")), 
                     reliability_test(df %>% filter(race == "Whites")), 
                     reliability_test(df %>% filter(race == "Blacks"))),
           Race = c("Asians","Latinx","Whites","Blacks")) %>%
  ggplot(aes(x = Race, y = Kappa)) +
  geom_point() + theme_base() + labs(title = "Reliability test", 
                                          y = "Conger's Kappa") +
  ylim(c(0.3, 0.5))

## With bootstrapping 

r1 <- reliability_boot_test(df %>% filter(race == "Asians"))
r2 <- reliability_boot_test(df %>% filter(race == "Latinx"))
r3 <- reliability_boot_test(df %>% filter(race == "Whites"))
r4 <- reliability_boot_test(df %>% filter(race == "Blacks"))

kappa_boot_plot <- data.frame(Kappa = c(r1[1], r2[1], r3[1], r4[1]),
           ub = c(r1[2], r2[2], r3[2], r4[2]),
           lb = c(r1[3], r2[3], r3[3], r4[3]),
           Race = c("Asians","Latinx","Whites","Blacks")) %>%
  ggplot(aes(x = Race, y = Kappa, ymax = ub, ymin = lb)) +
  geom_pointrange() + theme_base() + labs(title = "Reliability test (with Bootstrapping)", 
                                          y = "Conger's Kappa") +
  ylim(c(0.3, 0.5))

kappa_plot / kappa_boot_plot

  ggsave("/home/jae/validating-two-linked-fates/outputs/reliability_tests_plot.png")
  
```

### 5. Difference-in-means analysis 

#### 5.1. Difference-in-means tests (T-tests)

```{r}

# Individual case analysis 

diff_fate_progress <- df %>%
  group_by(race) %>%
  summarize(
    diff = mean(linked_fate) - mean(linked_progress),
    conf = ((t.test(linked_fate, linked_progress)$conf.int[2]) - t.test(linked_fate, linked_progress)$conf.int[1])/2,
    boot.conf = ((MKinfer::boot.t.test(linked_fate, linked_progress, R= 999)$boot.conf.int[2]) - MKinfer::boot.t.test(linked_fate, linked_progress, R= 999)$boot.conf.int[1])/2
    )

diff_fate_hurt <- df %>%
  group_by(race) %>%
  summarize(
    diff = mean(linked_fate) - mean(linked_hurt),
    conf = ((t.test(linked_fate, linked_hurt)$conf.int[2]) - t.test(linked_fate, linked_hurt)$conf.int[1])/2,
    boot.conf = ((MKinfer::boot.t.test(linked_fate, linked_hurt, R= 999)$boot.conf.int[2]) - MKinfer::boot.t.test(linked_fate, linked_hurt, R= 999)$boot.conf.int[1])/2
    )

# Combining the results 

diff_results <- bind_rows(mutate(diff_fate_progress, Type = "fate_progress"),
          mutate(diff_fate_hurt, Type = "fate_hurt"))

```

#### 5.2. Visualizing the results 

```{r}

d1 <- diff_results %>%  
  ggplot(aes(x = fct_reorder(race, diff), y = diff, 
             ymax = diff + conf, 
             ymin = diff - conf)) +
    geom_pointrange() +
    theme_base() +
    labs(x = "Race", y = "Difference in means",
         title = "Difference of means test results ") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(~Type) +
    ylim(c(-0.3,1.2))

d2 <- diff_results %>%  
  ggplot(aes(x = fct_reorder(race, diff), y = diff, 
             ymax = diff + boot.conf, 
             ymin = diff - boot.conf)) +
    geom_pointrange() +
    theme_base() +
    labs(x = "Race", y = "Difference in means",
         title = "Difference of means test results (with Bootstrapped CIs)") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(~Type) +
    ylim(c(-0.3,1.2))

d1

ggsave("/home/jae/validating-two-linked-fates/outputs/diff_in_means_plot.png", width = 10, height = 8)

```

